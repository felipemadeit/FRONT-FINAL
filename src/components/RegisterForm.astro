<form class="register-form" id="register-form">
    <div id="wrapper-input-data">
        <div id="wrapper-input-name">
            <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="#ffffff"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="icon icon-tabler icons-tabler-outline icon-tabler-writing"
                ><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path
                    d="M20 17v-12c0 -1.121 -.879 -2 -2 -2s-2 .879 -2 2v12l2 2l2 -2z"
                ></path><path d="M16 7h4"></path><path
                    d="M18 19h-13a2 2 0 1 1 0 -4h4a2 2 0 1 0 0 -4h-3"
                ></path></svg
            >
            <input
                id="name"
                type="text"
                name="name"
                required
                placeholder="Write your name"
            />
        </div>
        <div id="wrapper-input-document">
            <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="#ffffff"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="icon icon-tabler icons-tabler-outline icon-tabler-id"
                ><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path
                    d="M3 4m0 3a3 3 0 0 1 3 -3h12a3 3 0 0 1 3 3v10a3 3 0 0 1 -3 3h-12a3 3 0 0 1 -3 -3z"
                ></path><path d="M9 10m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0"
                ></path><path d="M15 8l2 0"></path><path d="M15 12l2 0"
                ></path><path d="M7 16l10 0"></path></svg
            >
            <input
                id="dni"
                type="number"
                name="dni"
                required
                placeholder="Write your identification"
            />
        </div>
        <div id="wrapper-input-phone">
            <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="#ffffff"
                class="icon icon-tabler icons-tabler-filled icon-tabler-phone"
                ><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path
                    d="M9 3a1 1 0 0 1 .877 .519l.051 .11l2 5a1 1 0 0 1 -.313 1.16l-.1 .068l-1.674 1.004l.063 .103a10 10 0 0 0 3.132 3.132l.102 .062l1.005 -1.672a1 1 0 0 1 1.113 -.453l.115 .039l5 2a1 1 0 0 1 .622 .807l.007 .121v4c0 1.657 -1.343 3 -3.06 2.998c-8.579 -.521 -15.418 -7.36 -15.94 -15.998a3 3 0 0 1 2.824 -2.995l.176 -.005h4z"
                ></path></svg
            >
            <input
                id="phone"
                type="number"
                name="phone"
                required
                placeholder="Write your number"
            />
        </div>
        <div id="wrapper-input-email">
            <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="#ffffff"
                class="icon icon-tabler icons-tabler-filled icon-tabler-mail"
                ><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path
                    d="M22 7.535v9.465a3 3 0 0 1 -2.824 2.995l-.176 .005h-14a3 3 0 0 1 -2.995 -2.824l-.005 -.176v-9.465l9.445 6.297l.116 .066a1 1 0 0 0 .878 0l.116 -.066l9.445 -6.297z"
                ></path><path
                    d="M19 4c1.08 0 2.027 .57 2.555 1.427l-9.555 6.37l-9.555 -6.37a2.999 2.999 0 0 1 2.354 -1.42l.201 -.007h14z"
                ></path></svg
            >
            <input
                id="email"
                type="email"
                name="email"
                required
                placeholder="Write your email"
            />
        </div>
        <div id="wrapper-input-username">
            <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="#ffffff"
                class="icon icon-tabler icons-tabler-filled icon-tabler-user"
                ><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path
                    d="M12 2a5 5 0 1 1 -5 5l.005 -.217a5 5 0 0 1 4.995 -4.783z"
                ></path><path
                    d="M14 14a5 5 0 0 1 5 5v1a2 2 0 0 1 -2 2h-10a2 2 0 0 1 -2 -2v-1a5 5 0 0 1 5 -5h4z"
                ></path></svg
            >
            <input
                id="username"
                type="text"
                name="username"
                required
                placeholder="Create a username"
            />
        </div>
        <div id="wrapper-input-password">
            <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="#ffffff"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="icon icon-tabler icons-tabler-outline icon-tabler-key"
                ><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path
                    d="M16.555 3.843l3.602 3.602a2.877 2.877 0 0 1 0 4.069l-2.643 2.643a2.877 2.877 0 0 1 -4.069 0l-.301 -.301l-6.558 6.558a2 2 0 0 1 -1.239 .578l-.175 .008h-1.172a1 1 0 0 1 -.993 -.883l-.007 -.117v-1.172a2 2 0 0 1 .467 -1.284l.119 -.13l.414 -.414h2v-2h2v-2l2.144 -2.144l-.301 -.301a2.877 2.877 0 0 1 0 -4.069l2.643 -2.643a2.877 2.877 0 0 1 4.069 0z"
                ></path><path d="M15 9h.01"></path></svg
            >
            <input
                id="password"
                type="password"
                name="password"
                minlength="8"
                pattern="(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{8,}"
                required
                placeholder="Create a secure password"
            />
        </div>
    </div>
    <div id="wrapper-button-create-acc">
        <button id="button-register" type="submit">Register</button>
    </div>
    
</form>

<script>
    const form = document.getElementById("register-form") as HTMLFormElement;
    const errorMessage = document.getElementById("error-message");
    const notificationDiv = document.getElementById("event-notification");

    let timeoutId = null;

    const showNotification = (message, type = "success", duration = 5000) => {
        if (timeoutId) {
            clearTimeout(timeoutId);
            hideNotification();
        }

        notificationDiv.className = ""; // Clear existing classes
        notificationDiv.classList.add("event-notification", `notification-${type}`);
        notificationDiv.textContent = message;

        setTimeout(() => {
            notificationDiv.classList.add("moved-notification");
        }, 100);

        timeoutId = setTimeout(() => {
            hideNotification();
        }, duration);
    };

    const hideNotification = () => {
        notificationDiv.classList.remove("moved-notification");
    };

    form.addEventListener("submit", async (event) => {
        event.preventDefault();

        if (errorMessage) {
            errorMessage.classList.add("hidden");
            errorMessage.textContent = "";
        }

        const formData = new FormData(form) ;
        const nombre = formData.get("name");
        const documento = formData.get("dni");
        const numero = formData.get("phone");
        const correo = formData.get("email");
        const username = formData.get("username");
        const password = formData.get("password");

        try {
            const response = await fetch(
                "http://localhost:8080/api/auth/admin/register",
                {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        username,
                        password,
                        nombre,
                        email: correo,
                        documento,
                        telefono: numero,
                    }),
                }
            );

            const text = await response.text();
            let data;

            try {
                data = JSON.parse(text);
            } catch {
                data = { message: text };
            }

            if (!response.ok) {
                const errorMessageText = data.message || "An error occurred during registration.";
                showNotification(errorMessageText, "error");
                throw new Error(errorMessageText);
            }

            // Registro exitoso
            showNotification("Account created successfully!", "success");
            localStorage.setItem("token", data.token);

            setTimeout(() => {
                window.location.href = "/login";
            }, 3000);
        } catch (error) {
            console.error("Error in registration:", error);

            if (errorMessage) {
                errorMessage.classList.remove("hidden");
                errorMessage.textContent = error.message || "Unknown error occurred.";
            }
        }
    });
</script>